args <- commandArgs(trailingOnly = TRUE)
# the first parameter needs to the directory for the custom R packages
# the second input parameter needs to be the kegg gsea result directory with the subdirectories for MG and MT already created by the previous scripts
# the third input parameter needs to be the lmm analysis results directory
# the fourth input parameter needs to be the file providing the selected KEGG core modules of interest for testing - needs to be prepared

# assumes a specific directory structure generated by default by the earlier scripts

# e.g.
# args <- character(4)
# args[1] <- "/projappl/project_2009164/project_rpackages_430"
# args[2] <- "/scratch/project_2009164/2_OULANKA/Tommi/final/downstream/metabolic_functional_datas/lmm_analysis/kegg_gsea_enrichment"
# args[3] <- "/scratch/project_2009164/2_OULANKA/Tommi/final/downstream/metabolic_functional_datas/lmm_analysis"
# args[4] <- "/scratch/project_2009164/2_OULANKA/Tommi/final/metadata/selected_KEGG_modules.txt"

# a small script to perform KEGG module gene set enrichment analysis (gsea) with the fgsea package for the lmm results

# load libraries
.libPaths(c(as.character(args[1]), .libPaths()))
library(fgsea)

# define custom functions
# function for overall gsea
fgseaOverall <- function(temp_res, rand_seed=1, test_modules, scoretype="std"){
  
  # prepare test statistic which will be 1-pvalue adjusted with the direction of change
  ranksTest <- 1-as.numeric(temp_res$pvalue)
  ranksTest[which(temp_res$coef<0)] <- ranksTest[which(temp_res$coef<0)]*(-1)
  names(ranksTest) <- as.character(rownames(temp_res))
  ranksTest <- na.omit(ranksTest)
  
  # shuffle the ranks in random order
  set.seed(rand_seed)
  ranksTest <- sample(ranksTest)
  
  # perform fgsea
  set.seed(rand_seed)
  fgsea_temp <- fgsea(pathways = test_modules, stats = ranksTest, scoreType = scoretype)
  fgsea_temp <- fgsea_temp[order(as.numeric(fgsea_temp$pval)),]
  fgsea_temp_save <- fgsea_temp[, 1:(ncol(fgsea_temp)-1)]
  fgsea_temp_save$leadingEdge <- unlist(lapply(fgsea_temp$leadingEdge, function(x) paste(x, collapse = "; ")))
  
  # ret_list <- list(fgsea_temp, fgsea_temp_save)
  # names(ret_list) <- c("fgsea_res", "fgsea_res_ledge_parsed")
  
  return(fgsea_temp_save)
}

# set working directories
wd1 <- as.character(args[2])
wd2 <- as.character(args[3])

# only include the seleceted interesting modules for the enrichment analysis - not all possible modules
modules_curated <- read.csv(file = as.character(args[4]), quote = "", fill=F, stringsAsFactors = F, sep = "\t", header = F)

# get module identifiers
ko_modules_curated  <- strsplit(x = modules_curated[,1], split = " ")
ko_modules_curated <- unlist(lapply(ko_modules_curated, function(x) x[1]))

setwd(wd1)
dirs_list <- list.files()

keep_items <- ls()
keep_items <- c(keep_items, "keep_items")
for(dir in 1:length(dirs_list)){
  print(paste("Processing data:", dirs_list[dir]))
  
  # load the corresponding results to be analyzed
  setwd(wd2)
  setwd(dirs_list[dir])
  load("lmm_analysis_done.RData")
  
  setwd(wd1)
  setwd(dirs_list[dir])
  
  # read-in the module completeness estimates from anvi'o
  modules_info <- read.csv("metabolism_modules.txt", sep = "\t")

  # select only the modules complete enough - 75% currently - use stepwise completeness
  modules_3_4 <- modules_info[which(modules_info$stepwise_module_is_complete=="True"),]
  
  # use only the pathway modules
  modules_3_4 <- modules_3_4[which(modules_3_4$module_class%in%"Pathway modules"),]

  # include only the complete enough modules from the modules of interest
  modules_selected <- modules_3_4[which(modules_3_4$module%in%ko_modules_curated),]

  # make a list of the selected modules for gsea - overall enrichment
  ko_modules_selected <- list()
  for(j in 1:nrow(modules_selected)){
    # parse the KO groups in the module
    ko_modules_selected[[j]] <- unique(unlist(strsplit(x = gsub("[-]", ",",gsub("[+]", ",",gsub(" ", ",",gsub("[)]", "", gsub("[(]","",modules_selected$module_definition[j]))))), split = ",")))
  }
  names(ko_modules_selected) <- paste(modules_selected$module, modules_selected$module_name, sep = "_")
  

  # perform gene set enrichment analysis using fgsea
  # exclusion treatment
  # pick the correct lmm results
  temp_res <- data.frame(coefficients_lmm_simple$grazinggrazed, sig_values_lmm_simple$grazinggrazed)
  colnames(temp_res) <- c("coef", "pvalue")
  rownames(temp_res) <- rownames(sig_values_lmm_simple)
  # gsea
  temp_fgsea <- fgseaOverall(temp_res = temp_res, rand_seed = 1, test_modules = ko_modules_selected)
  fgsea_grazed <- temp_fgsea
  
  # snow addition
  temp_res <- data.frame(coefficients_lmm_simple$`treatment+S`, sig_values_lmm_simple$`treatment+S`)
  colnames(temp_res) <- c("coef", "pvalue")
  rownames(temp_res) <- rownames(sig_values_lmm_simple)
  # gsea
  temp_fgsea <- fgseaOverall(temp_res = temp_res, rand_seed = 1, test_modules = ko_modules_selected)
  fgsea_snow_addition <- temp_fgsea
  
  # snow decrease
  temp_res <- data.frame(coefficients_lmm_simple$`treatment-S`, sig_values_lmm_simple$`treatment-S`)
  colnames(temp_res) <- c("coef", "pvalue")
  rownames(temp_res) <- rownames(sig_values_lmm_simple)
 # gsea
  temp_fgsea <- fgseaOverall(temp_res = temp_res, rand_seed = 1, test_modules = ko_modules_selected)
  fgsea_snow_decrease <- temp_fgsea
  
  # save everything
  save(fgsea_grazed, fgsea_snow_addition,fgsea_snow_decrease, ko_modules_selected, modules_selected, modules_3_4, modules_info,
       file = "fgsea_results.RData")
  
  # clean
  del_items <- ls()
  del_items <- del_items[-which(del_items%in%keep_items)]
  rm(list = del_items)
  
  print("Data processed.")
  print("***************************************************************")
  
}

# print out session info
print("SessionInfo:")
sessionInfo()
